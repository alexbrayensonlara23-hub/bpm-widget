<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DripSounds BPM Detector</title>
  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --accent: #00ffe0; /* Ajusta al color de marca */
      --muted: #1a1a1a;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px;
      background: var(--bg); color: var(--fg);
      font-family: 'Helvetica Neue', sans-serif;
      display: flex; flex-direction: column; align-items: center;
    }
    h1 {
      font-size: 1.5em; font-weight: 500; margin-bottom: 1em;
      color: var(--accent);
    }
    .controls {
      display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1em;
    }
    input[type="file"], button, input[type="range"] {
      background: transparent; color: var(--fg);
      border: 1px solid var(--fg); border-radius: 4px;
      padding: 8px 12px; font-size: 14px;
    }
    button:hover {
      background: var(--accent); color: var(--bg);
      border-color: var(--accent);
    }
    #bpm {
      font-size: 1.8em; font-weight: bold; margin-top: 0.5em;
    }
    .bar {
      width: 100%; max-width: 600px; height: 6px;
      background: var(--muted); border-radius: 3px; overflow: hidden;
      margin-top: 1em;
    }
    .bar > div {
      height: 100%; width: 0%; background: var(--accent);
      transition: width 0.1s linear;
    }
    canvas {
      margin-top: 1em; background: var(--muted);
      border: 1px solid var(--fg); width: 100%; max-width: 600px; height: 150px;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ§ DripSounds BPM Detector</h1>
  <div class="controls">
    <input type="file" id="file" accept="audio/*">
    <button id="analyzeBtn">Analizar BPM</button>
    <button id="playBtn" disabled>Play</button>
    <button id="pauseBtn" disabled>Pause</button>
    <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8">
  </div>
  <div id="bpm">BPM: --</div>
  <div class="bar"><div id="progress"></div></div>
  <canvas id="canvas"></canvas>

  <script>
    let audioCtx, gainNode, buffer, source, analyser, dataArray, canvasCtx;
    let startTime = 0, pausedAt = 0, isPlaying = false, rafId;

    const fileEl = document.getElementById('file');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const volEl = document.getElementById('vol');
    const bpmEl = document.getElementById('bpm');
    const progressEl = document.getElementById('progress');

    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      gainNode = audioCtx.createGain();
      gainNode.gain.value = parseFloat(volEl.value);
      gainNode.connect(audioCtx.destination);
    }
    initAudio();

    function createSource() {
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      src.connect(gainNode);
      src.onended = () => { if (isPlaying) stopPlayback(false); };
      return src;
    }

    function startProgressLoop() {
      cancelAnimationFrame(rafId);
      const loop = () => {
        if (!buffer) return;
        const now = isPlaying ? (pausedAt + (audioCtx.currentTime - startTime)) : pausedAt;
        const ratio = Math.min(1, now / buffer.duration);
        progressEl.style.width = `${ratio * 100}%`;
        rafId = requestAnimationFrame(loop);
      };
      rafId = requestAnimationFrame(loop);
    }

    async function loadFileToBuffer(file) {
      const arrayBuffer = await file.arrayBuffer();
      return await audioCtx.decodeAudioData(arrayBuffer);
    }

    function stopPlayback(reset = true) {
      try { source && source.stop(0); } catch(e) {}
      source = null;
      isPlaying = false;
      if (reset) pausedAt = 0;
      pauseBtn.disabled = true;
      playBtn.disabled = !buffer;
    }

    function play() {
      if (!buffer || isPlaying) return;
      source = createSource();
      startTime = audioCtx.currentTime;
      source.start(0, pausedAt);
      isPlaying = true;
      playBtn.disabled = true;
      pauseBtn.disabled = false;
      startProgressLoop();
    }

    function pause() {
      if (!buffer || !isPlaying) return;
      pausedAt += (audioCtx.currentTime - startTime);
      stopPlayback(false);
      startProgressLoop();
    }

    volEl.addEventListener('input', () => {
      gainNode.gain.value = parseFloat(volEl.value);
    });
    playBtn.addEventListener('click', () => { audioCtx.resume(); play(); });
    pauseBtn.addEventListener('click', pause);

    analyzeBtn.addEventListener('click', async () => {
      const file = fileEl.files[0];
      if (!file) return alert('Selecciona un archivo de audio.');
      stopPlayback(true);
      buffer = await loadFileToBuffer(file);
      const { bpm } = estimateBPM(buffer);
      bpmEl.textContent = Number.isFinite(bpm) ? `BPM: ${Math.round(bpm)}` : 'BPM: No detectado';
      playBtn.disabled = !buffer;
      pausedAt = 0;
      progressEl.style.width = '0%';
      setupVisualizer();
    });

    function setupVisualizer() {
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      dataArray = new Float32Array(analyser.fftSize);
      gainNode.disconnect();
      gainNode.connect(analyser);
      analyser.connect(audioCtx.destination);
      const canvas = document.getElementById('canvas');
      canvasCtx = canvas.getContext('2d');
      drawVisualizer();
    }

    function drawVisualizer() {
      requestAnimationFrame(drawVisualizer);
      analyser.getFloatTimeDomainData(dataArray);
      canvasCtx.fillStyle = '#1a1a1a';
      canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
      canvasCtx.lineWidth = 2;
      canvasCtx.strokeStyle = '#00ffe0';
      canvasCtx.beginPath();
      const sliceWidth = canvas.width / dataArray.length;
      let x = 0;
      for (let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i] * 50;
        const y = canvas.height / 2 - v;
        i === 0 ? canvasCtx.moveTo(x, y) : canvasCtx.lineTo(x, y);
        x += sliceWidth;
      }
      canvasCtx.lineTo(canvas.width, canvas.height / 2);
      canvasCtx.stroke();
    }

    function estimateBPM(buf) {
      const sr = buf.sampleRate;
      const data = buf.getChannelData(0);
      const peaks = [];
      for (let i = 0; i < data.length; i += 1024) {
        const slice = data.slice(i, i + 1024);
        const peak = Math.max(...slice);
        if (peak > 0.3) peaks.push(i / sr);
      }
      const intervals = [];
      for (let i = 1; i < peaks.length; i++) intervals.push(peaks[i] - peaks[i - 1]);
      if (!intervals.length) return { bpm: NaN };
      const avg = intervals.reduce((a, b) => a + b

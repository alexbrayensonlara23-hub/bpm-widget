<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DripSounds BPM Detector</title>
  <style>
    :root {
      --bg: #fff;
      --fg: #000;
      --muted: #e6e6e6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      background: var(--bg); color: var(--fg);
      font-family: 'Helvetica Neue', Arial, sans-serif;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh;
    }
    .card {
      width: 100%; max-width: 720px; padding: 20px;
      border: 1px solid var(--fg); border-radius: 8px;
      background: transparent;
    }
    h1 {
      font-size: 22px; font-weight: 600; margin-bottom: 16px;
      color: var(--fg); text-align: center;
    }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: center; }
    .btn, .file, .range {
      border: 1px solid var(--fg); background: transparent; color: var(--fg);
      padding: 10px 12px; border-radius: 6px; font-size: 14px;
      transition: all 0.2s ease;
    }
    .btn:hover {
      background: var(--fg); color: var(--bg);
    }
    .file { padding: 8px; }
    .range { width: 180px; height: 36px; padding: 0 8px; }
    .range input[type="range"] {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 4px; background: var(--fg); outline: none; border-radius: 2px;
    }
    .range input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 14px; height: 14px; border-radius: 50%; background: var(--fg);
      cursor: pointer;
    }
    .stat {
      font-size: 28px; font-weight: 600; letter-spacing: 0.5px; margin-top: 8px;
      text-align: center;
    }
    .muted { color: #555; font-size: 12px; text-align: center; }
    .bar {
      margin-top: 14px; width: 100%; height: 6px; background: var(--muted);
      border-radius: 3px; overflow: hidden;
    }
    .bar > div {
      height: 100%; width: 0%; background: var(--fg);
      transition: width 0.1s linear;
    }
    .capsule {
      border: 1px solid var(--fg); border-radius: 999px; padding: 6px 10px; font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸŽ§ DripSounds BPM Detector</h1>

    <div class="row">
      <input class="file" id="file" type="file" accept="audio/*" />
      <button class="btn" id="analyzeBtn">Analizar BPM</button>
      <button class="btn" id="playBtn" disabled>Play</button>
      <button class="btn" id="pauseBtn" disabled>Pause</button>
      <label class="range">
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8" />
      </label>
    </div>

    <div class="row" style="gap:24px; margin-top: 16px;">
      <div>
        <div class="muted">Resultado</div>
        <div id="bpm" class="stat">BPM: --</div>
      </div>
      <div>
        <div class="muted">Confianza</div>
        <div id="conf" class="capsule">--</div>
      </div>
      <div>
        <div class="muted">DuraciÃ³n</div>
        <div id="dur" class="capsule">--</div>
      </div>
    </div>

    <div class="bar" aria-label="Progreso">
      <div id="progress"></div>
    </div>

    <div class="muted" id="status" style="margin-top:10px;">Carga un archivo de audio y presiona Analizar BPM.</div>
  </div>

  <script>
    let audioCtx, gainNode, buffer = null, source = null;
    let startTime = 0, pausedAt = 0, isPlaying = false, rafId = null;

    const fileEl = document.getElementById('file');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const volEl = document.getElementById('vol');
    const bpmEl = document.getElementById('bpm');
    const confEl = document.getElementById('conf');
    const durEl = document.getElementById('dur');
    const statusEl = document.getElementById('status');
    const progressEl = document.getElementById('progress');

    initAudio();

    function initAudio() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      gainNode = audioCtx.createGain();
      gainNode.gain.value = parseFloat(volEl.value);
      gainNode.connect(audioCtx.destination);
    }

    function createSource() {
      if (!buffer) return null;
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;
      src.connect(gainNode);
      src.onended = () => { if (isPlaying) stopPlayback(false); };
      return src;
    }

    function startProgressLoop() {
      cancelAnimationFrame(rafId);
      const loop = () => {
        if (!buffer) return;
        const now = isPlaying ? (pausedAt + (audioCtx.currentTime - startTime)) : pausedAt;
        const ratio = Math.min(1, now / buffer.duration);
        progressEl.style.width = `${ratio * 100}%`;
        rafId = requestAnimationFrame(loop);
      };
      rafId = requestAnimationFrame(loop);
    }

    async function loadFileToBuffer(file) {
      const arrayBuffer = await file.arrayBuffer();
      return await audioCtx.decodeAudioData(arrayBuffer);
    }

    function stopPlayback(resetPosition = true) {
      try { source && source.stop(0); } catch(e) {}
      source = null;
      isPlaying = false;
      if (resetPosition) pausedAt = 0;
      pauseBtn.disabled = true;
      playBtn.disabled = !buffer;
    }

    function play() {
      if (!buffer || isPlaying) return;
      source = createSource();
      if (!source) return;
      startTime = audioCtx.currentTime;
      source.start(0, pausedAt);
      isPlaying = true;
      playBtn.disabled = true;
      pauseBtn.disabled = false;
      startProgressLoop();
    }

    function pause() {
      if (!buffer || !isPlaying) return;
      pausedAt += (audioCtx.currentTime - startTime);
      stopPlayback(false);
      startProgressLoop();
    }

    volEl.addEventListener('input', () => {
      gainNode.gain.value = parseFloat(volEl.value);
    });
    playBtn.addEventListener('click', () => { audioCtx.resume(); play(); });
    pauseBtn.addEventListener('click', pause);

    analyzeBtn.addEventListener('click', async () => {
      const file = fileEl.files && fileEl.files[0];
      if (!file) return alert('Selecciona un archivo de audio.');
      stopPlayback(true);
      statusEl.textContent = 'Analizando BPM...';
      try {
        buffer = await loadFileToBuffer(file);
        durEl.textContent = formatTime(buffer.duration);
        const { bpm } = estimateBPM(buffer);
        bpmEl.textContent = Number.isFinite(bpm) ? `BPM: ${Math.round(bpm)}` : 'BPM: No detectado';
        confEl.textContent = '--';
        statusEl.textContent = 'AnÃ¡lisis completado.';
        playBtn.disabled = !buffer;
        pausedAt = 0;
        progressEl.style.width = '0%';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error al procesar el audio.';
        bpmEl.textContent = 'BPM: --';
        confEl.textContent = '--';
      }
    });

        function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function estimateBPM(buf) {
      const sr = buf.sampleRate;
      const data = buf.getChannelData(0);
      const peaks = [];
      for (let i = 0; i < data.length; i += 1024) {
        const slice = data.slice(i, i + 1024);
        const peak = Math.max(...slice);
        if (peak > 0.3) peaks.push(i / sr);
      }
      const intervals = [];
      for (let i = 1; i < peaks.length; i++) {
        intervals.push(peaks[i] - peaks[i - 1]);
      }
      if (!intervals.length) return { bpm: NaN };
      const avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;
      const bpm = 60 / avg;
      return { bpm };
    }
  </script>
</body>
</html>


